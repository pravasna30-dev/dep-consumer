name: Cross-Build Composite - Gradle Consumer ← Bazel Producer

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  happy-path:
    name: "Happy Path - Consumer Tests Pass"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dep-consumer
        uses: actions/checkout@v4

      - name: Clone bazel-monorepo (producer)
        run: git clone --depth 1 https://github.com/pravasna30-dev/bazel-monorepo.git ../bazel-monorepo

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Build producer JAR via Bazel
        working-directory: ../bazel-monorepo
        run: bazel build //low-level-1

      - name: Publish producer JAR to Maven Local
        working-directory: ../bazel-monorepo
        run: |
          GROUP_ID="com.acme"
          ARTIFACT_ID="low-level-1"
          VERSION="1.0.0"
          M2_DIR="$HOME/.m2/repository/com/acme/low-level-1/$VERSION"

          JAR_PATH="$(find bazel-bin/low-level-1 -name 'liblow-level-1.jar' -type f | head -1)"
          echo "Found JAR: $JAR_PATH"

          mkdir -p "$M2_DIR"
          rm -f "$M2_DIR/$ARTIFACT_ID-$VERSION.jar"
          cp "$JAR_PATH" "$M2_DIR/$ARTIFACT_ID-$VERSION.jar"
          chmod 644 "$M2_DIR/$ARTIFACT_ID-$VERSION.jar"

          cat > "$M2_DIR/$ARTIFACT_ID-$VERSION.pom" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${VERSION}</version>
            <packaging>jar</packaging>
          </project>
          EOF

          echo "Published $GROUP_ID:$ARTIFACT_ID:$VERSION to Maven Local"

      - name: Run consumer tests
        run: |
          chmod +x gradlew
          ./gradlew test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-happy-path
          path: build/reports/tests/

  breaking-change:
    name: "Breaking Change - Detected at Compile Time"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dep-consumer
        uses: actions/checkout@v4

      - name: Clone bazel-monorepo (producer)
        run: git clone --depth 1 https://github.com/pravasna30-dev/bazel-monorepo.git ../bazel-monorepo

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Build and publish producer JAR (baseline)
        working-directory: ../bazel-monorepo
        run: |
          bazel build //low-level-1
          M2_DIR="$HOME/.m2/repository/com/acme/low-level-1/1.0.0"
          JAR_PATH="$(find bazel-bin/low-level-1 -name 'liblow-level-1.jar' -type f | head -1)"
          mkdir -p "$M2_DIR"
          rm -f "$M2_DIR/low-level-1-1.0.0.jar"
          cp "$JAR_PATH" "$M2_DIR/low-level-1-1.0.0.jar"
          chmod 644 "$M2_DIR/low-level-1-1.0.0.jar"
          cat > "$M2_DIR/low-level-1-1.0.0.pom" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.acme</groupId>
            <artifactId>low-level-1</artifactId>
            <version>1.0.0</version>
            <packaging>jar</packaging>
          </project>
          EOF

      - name: Verify happy path first
        run: |
          chmod +x gradlew
          ./gradlew test

      - name: Introduce breaking change in producer
        working-directory: ../bazel-monorepo
        run: |
          echo "=== Before change ==="
          grep "say" low-level-1/src/main/java/com/acme/arc/dep/test/LowOneMain.java
          echo ""
          echo "=== Applying breaking change: say() → speak() ==="
          sed -i 's/public static void say()/public static void speak()/' \
            low-level-1/src/main/java/com/acme/arc/dep/test/LowOneMain.java
          sed -i 's/say();/speak();/' \
            low-level-1/src/main/java/com/acme/arc/dep/test/LowOneMain.java
          echo ""
          echo "=== After change ==="
          cat low-level-1/src/main/java/com/acme/arc/dep/test/LowOneMain.java

      - name: Rebuild and republish broken producer JAR
        working-directory: ../bazel-monorepo
        run: |
          bazel build //low-level-1
          M2_DIR="$HOME/.m2/repository/com/acme/low-level-1/1.0.0"
          JAR_PATH="$(find bazel-bin/low-level-1 -name 'liblow-level-1.jar' -type f | head -1)"
          rm -f "$M2_DIR/low-level-1-1.0.0.jar"
          cp "$JAR_PATH" "$M2_DIR/low-level-1-1.0.0.jar"
          chmod 644 "$M2_DIR/low-level-1-1.0.0.jar"
          echo "Republished broken JAR to Maven Local"

      - name: Run consumer tests (expect compile failure)
        run: |
          echo "=== Running consumer tests against broken producer ==="
          ./gradlew clean test 2>&1 || true
          if ./gradlew clean test 2>&1; then
            echo "ERROR: Tests should have failed but passed!"
            exit 1
          else
            echo ""
            echo "=== SUCCESS: Breaking change detected at compile time ==="
            echo "The Gradle consumer correctly caught the incompatible API change in the Bazel producer."
          fi
